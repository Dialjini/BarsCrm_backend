let list_items_acc,list_stock_acc;function editAccount(e){let t=e.name.split("_")[1];$.ajax({url:"/getStockTable",type:"GET",dataType:"html",success:function(i){let n,a;i=JSON.parse(i);let l=[];for(let e of $("#exposed_list .invoiled")){let t=$(e).attr("id").split("_")[1];for(let e=0;e<i.length;e++)for(let n=0;n<i[e].items.length;n++){i[e].items[n].Item_id==t&&l.push({id:+t,volume:$(`#invoiled_volume_${t}`).val()})}}for(let e=0;e<categoryInFinanceAccount[1][1].length;e++)categoryInFinanceAccount[1][1][e].account.id==t&&(n=categoryInFinanceAccount[1][1][e].account.Name,a=categoryInFinanceAccount[1][1][e].account.Date,shipment=categoryInFinanceAccount[1][1][e].account.Shipment);if("true"===shipment)return $(".page").append($("<div>",{class:"background"}).add('\n                                <div class="modal_select">\n                                    <div class="title">\n                                        <span>Ошибка</span>\n                                        <img onclick="closeModal()" src="static/images/cancel.png">\n                                    </div>\n                                    <div class="content">\n                                        <div class="message">\n                                            <p style="font-size: 14px; color: #595959;">Товар(/ы) этого счета уже полностью отгружен(/ы)</p>\n                                        </div>\n                                    </div>\n                                </div>\n                            '));if(l.length>0){let i=[],d=[],s=[],c=[];for(let e of $("#exposed_list .invoiled")){let t=$(e).attr("id").split("_")[1];i.push($(e).children()[7].children[0].value),d.push($(e).children()[8].children[0].value),s.push($(e).children()[9].children[0].value),c.push({id:+t,amount:$(e).children()[11].innerHTML})}let o=$("#total").html();$.ajax({url:"/getThisUser",type:"GET",dataType:"html",success:function(r){let p=JSON.parse(r);$.ajax({url:"/editAccount",type:"GET",data:{account_id:+t,status:String($("#account_status").prop("checked")),manager_id:p.id,name:n,date:a,hello:JSON.stringify(d),sale:JSON.stringify(i),shipping:JSON.stringify(s),items_amount:JSON.stringify(c),sum:o,item_ids:JSON.stringify(l),total_costs:$("#total_costs_inv").val(),sale_costs:$("#total_discount_inv").val(),hello_costs:$("#total_privet_inv").val(),delivery_costs:$("#total_delivery_inv").val(),shipment:shipment,shipment_hello:$("#shipment_date").val()},dataType:"html",success:function(){checkStocks(e)}})}})}else if(0==l.length)return void alert("Невозможно отредактировать счет, ни один товара нет в счете!")}})}function checkStocks(e){let t=e.name.split("_")[1],i=[];for(let e of $("#group tr")){let t=$(e)[0].children[0].children[0].value,n=$(e)[0].children[1].children[0].value;i.push({date:t,sum:n})}0==i.length&&i.push({date:"",sum:""}),$.ajax({url:"/addAccountPaymentHistory",data:{account_id:+t,account_payment_history:JSON.stringify(i)},type:"GET",dataType:"html",success:function(){list_stock_acc=$("#stock_items_list").attr("data-stock").split(","),list_items_acc=$("#stock_items_list").attr("data-items").split(",");let t,i,n=[];$.ajax({url:"/getStocks",type:"GET",async:!1,dataType:"html",success:function(e){t=JSON.parse(e)}}),$.ajax({url:"/getAllItems",type:"GET",async:!1,dataType:"html",success:function(e){i=JSON.parse(e)}});for(let e=0;e<t.length;e++)for(let i=0;i<list_stock_acc.length;i++)list_stock_acc[i]==t[e].id&&n.push({stock:t[e].id,items:[]});for(let e=0;e<n.length;e++)for(let t=0;t<i.length;t++)n[e].stock==i[t].Stock_id&&n[e].items.push(i[t].Item_id);if(list_stock_acc.length>1)$(".page").prepend($("<div>",{class:"background"})),$(".page").prepend($("<div>",{class:"modal_select",append:`\n                            <div class="title">\n                                <span>Выбор склада</span>\n                                <img onclick="closeModal()" src="static/images/cancel.png">\n                            </div>\n                            <div class="content">\n                                <div class="message">\n                                    <p>В счёте присутствуют несколько складов. Выберите один или несколько для выгрузки из них товаров, относящемся к этим складам<br>\n                                    (Доставка будет только на те товары, которые находятся в выбранных складах)</p>\n                                </div>\n                                <div class="list_stock">\n                                    ${function(){let e="",i=[],a=[];for(let l=0;l<t.length;l++)for(let d=0;d<n.length;d++)if(t[l].id==n[d].stock){for(let e=0;e<n[d].items.length;e++)a.push(n[d].items[e]);i.push(t[l].Name);let s=n[d].items.join("-s!s-");e+=`<button class="selectStock" onclick="selectThisStock(this)" name="delivery_stock_select" id="delivery_stock_${t[l].id}" data-items="${s}" data-stock="${t[l].Name}">${t[l].Name}</button>`;break}return e+`<button class="selectStock" onclick="selectThisStock(this)" name="delivery_stock_select" id="delivery_stock_all" data-items="${a.join("-s!s-")}" data-stock="${i.join("-s!s-")}">Все склады в счете</button>`}()}\n                                </div>\n                                <div style="text-align: right;margin-top: 30px;">\n                                    <button class="btn btn-main" onclick="arrangeDelivery(this)" name="${e.name}" id="${e.id}">Отгрузить</button>\n                                </div>\n                            </div>\n                        `}));else{for(let e=0;e<t.length;e++)for(let i=0;i<list_stock_acc.length;i++)t[e].id==list_stock_acc[i]&&(list_stock_acc[i]=t[e].Name);$(e).attr("data-stock",list_stock_acc),$(e).attr("data-items",list_items_acc),arrangeDelivery(e)}}})}function closeModal(){$(".background").remove(),$(".modal_select").remove()}function selectThisStock(e){if($(e).hasClass("active_button_stock"))$(e).removeClass("active_button_stock");else{if("delivery_stock_all"==e.id)for(let e of $(".active_button_stock"))$(e).removeClass("active_button_stock");$("#delivery_stock_all").hasClass("active_button_stock")&&$("#delivery_stock_all").removeClass("active_button_stock"),$(e).addClass("active_button_stock")}}function arrangeDelivery(e){list_stock_acc=[],list_items_acc=[];for(let e of $(".active_button_stock")){let t=$(e).attr("data-stock").split("-s!s-"),i=$(e).attr("data-items").split("-s!s-");for(let e=0;e<t.length;e++)list_stock_acc.push(t[e]);for(let e=0;e<i.length;e++)list_items_acc.push(i[e])}if(0==list_stock_acc.length&&0==list_items_acc.length){let t=$(e).attr("data-stock").split("-s!s-"),i=$(e).attr("data-items").split("-s!s-");for(let e=0;e<t.length;e++)list_stock_acc.push(t[e]);for(let e=0;e<i.length;e++)list_items_acc.push(i[e])}console.log(list_items_acc,list_stock_acc),closeModal(),categoryInFinanceAccount[0].lastCard[0]=null,$.ajax({url:"/getAccounts",type:"GET",async:!1,dataType:"html",success:function(e){e=JSON.parse(e),null==categoryInFinanceAccount[1][1]&&categoryInFinanceAccount[1].push(e)}}),e.id="delivery_new",createDelCardMenu(e)}function fillVolume(e){let t=$(e).val();$("#volume_goods").html(returnSpaces(deleteSpaces(t)))}function contractContentCard(e){return`\n        <div class="row_card column">\n            <div class="row_card" style="justify-content: flex-start">\n                <table class="fit gray">\n                    <tr><td class="bold" style="padding-right: 10px;">Договор от</td><td>${getCurrentDateNotComparison("currentYear")}</td></tr>\n                    <tr>\n                        <td class="bold">Юр. лицо</td><td>\n                            <select id="select_cusmoter">\n                                <option selected value="ООО">ООО</option>\n                                <option value="ИП">ИП</option>\n                            </select>\n                        </td>\n                    </tr>\n                </table>\n                <div class="new_contract flex" name="${e.name}" onclick="downloadDocument(this)">\n                    <img style="width: 15px;" src="static/images/plus.svg">\n                </div>\n            </div>\n            <div class="list" id="list_contract">\n                ${function(){let t,i="";$.ajax({url:"/getDocs",type:"GET",async:!1,dataType:"html",success:function(e){t=JSON.parse(e)}});let n=[{category:"client",name:"Договор поставки от"},{category:"carrier",name:"Договор об оказании услуг перевозки грузов от"}];e.name.includes("new")&&(e.name=e.name.replace(/new/g,saveTableAndCard[1][1].length+1));for(let a=0;a<t.length;a++)for(let l=0;l<n.length;l++)t[a].Owner_type==e.id&&e.id==n[l].category&&t[a].Owner_id==e.name.split("_")[1]&&(i+=`\n                    <div class="contract flex" name="${n[l].name} ${t[a].Prefix}" id="${t[a].id}" onclick="downloadOldDocument(this)">\n                        <div class="format">DOCX</div>\n                        <div class="date_number">\n                            <div class="top">${t[a].Creation_date}</div>\n                            <div class="bottom">№ ${t[a].MonthNum}/${t[a].Date}</div>\n                        </div>\n                        <span>${n[l].name} ${t[a].Prefix}</span>\n                    </div>\n                    `);return i}()}\n            </div>\n        </div>\n        <div class="row_card">\n            ${function(){if(e.name.includes("client")){let i,n,a;return $.ajax({url:"/getAccounts",type:"GET",async:!1,dataType:"html",success:function(e){i=JSON.parse(e)}}),$.ajax({url:"/getUsers",type:"GET",async:!1,dataType:"html",success:function(e){n=JSON.parse(e)}}),$.ajax({url:"/getAllItems",type:"GET",async:!1,dataType:"html",success:function(e){a=JSON.parse(e)}}),`\n                <table class="new_table">\n                    ${function(){let l="\n                        <tr>\n                            <th>Юр. лицо</th>\n                            <th>Дата выставления</th>\n                            <th>Товары</th>\n                            <th>Цена, руб.</th>\n                            <th>Сумма, руб.</th>\n                            <th>Статус</th>\n                            <th>Приветы</th>\n                            <th>Менеджер</th>\n                        </tr>",d=e.name.split("_")[1];for(let e=0;e<i.length;e++)for(let s=0;s<saveTableAndCard[1][1].length;s++)if(saveTableAndCard[1][1][s].Name===i[e].account.Name&&d==saveTableAndCard[1][1][s].id){let d,s="",c=i[e].account;if(null!=c.Payment_history){let e=JSON.parse(c.Payment_history),t=deleteSpaces(c.Sum),i=0;for(let t=0;t<e.length;t++)i+=+deleteSpaces(e[t].sum);+deleteSpaces(t)<=+deleteSpaces(i)?status='<span class="green">Оплачено</span>':status='<span class="red">Не оплачено</span>'}else status='<span class="red">Не оплачено</span>';for(let e=0;e<n.length;e++){if(+n[e].id==+c.Manager_id){d=null==n[e].second_name?"Фамилия не указана":n[e].second_name;break}d="Не выбран"}let o=0,r=JSON.parse(c.Hello);for(let e=0;e<r.length;e++)o+=+deleteSpaces(r[e]);let p=JSON.parse(c.Items_amount),u=[];for(let e=0;e<p.length;e++)for(t=0;t<a.length;t++)p[e].id===a[t].Item_id&&u.push(a[t].Name);s+=`\n                            <tbody>\n                                <tr>\n                                    <td rowspan="${p.length}">${i[e].items[0].Prefix}</td>\n                                    <td rowspan="${p.length}">${c.Date}</td>\n                                    <td>${u[0]}</td>\n                                    <td>${returnSpaces(p[0].amount)}</td>\n                                    <td rowspan="${p.length}">${returnSpaces(c.Sum)}</td>\n                                    <td rowspan="${p.length}">${status}</td>\n                                    <td rowspan="${p.length}">${returnSpaces(+o.toFixed(2))}</td>\n                                    <td rowspan="${p.length}">${d}</td>\n                                </tr>\n                            `;for(let e=1;e<p.length;e++)s+=`\n                                    <tr>\n                                        <td>${u[e]}</td>\n                                        <td>${returnSpaces(p[e].amount)}</td>\n                                    </tr>`;l+=s+"</tbody>"}return l}()}\n                </table>\n            `}return""}()}\n        </div>\n        <div class="next">\n            ${function(){let t=$(e).attr("name").split("_");return e.name.includes("client")?`\n                <button class="btn" style="margin-right: 10px" id="${e.id}" onclick="comeBack(this.id)">Назад</button> \n                <button class="btn btn-main" name="${t[0]}_${t[1]}" id="${e.id}" onclick="invoiceCard(this)">Вперёд</button> \n            `:e.name.includes("carrier")?`\n                <button class="btn" style="margin-right: 10px" id="${e.id}" onclick="comeBack(this.id)">Назад</button> \n                <button class="btn btn-main" name="${t[0]}_close_card_${t[1]}_contract" onclick="closeCardMenu(this.name)">Закрыть</button> \n            `:void 0}()}\n        </div>`}function downloadOldDocument(e){const t=document.createElement("a");t.href=`/downloadOldDoc?id=${e.id}`,t.download=$(e).attr("name")+".docx",t.click()}function viewFullField(e){if(!$("div").is(`#${e}_full_info`)){let t=$(`#${e}`).val();$(`#${e}`).parent().append(`\n            <div class="full_field" id="${e}_full_info" style="">${t}</div>\n        `)}}function hiddenFullField(e){$(`#${e}_full_info`).remove()}function inputFieldDoc(e,t,i,n){$.ajax({url:"/downloadDoc",data:{category:e[0],name:t,card_id:e[1],address:i,delivery:"no"},type:"GET",dataType:"html",success:function(t){if("BAD ADDRESS or INN"==t)return $(".page").append($("<div>",{class:"background"}).add('\n                    <div class="modal_select">\n                        <div class="title">\n                            <span>Ошибка</span>\n                            <img onclick="closeModal()" src="static/images/cancel.png">\n                        </div>\n                        <div class="content">\n                            <div class="message">\n                                <p style="font-size: 13px; color: #595959;">Проверьте корректность ввода ИНН и почтового индекса в карточке клиента</p>\n                            </div>\n                        </div>\n                    </div>\n                '));$.ajax({url:"/getDocs",type:"GET",dataType:"html",success:function(t){let i="",a=JSON.parse(t),l=[{category:"client",name:"Договор поставки от"},{category:"carrier",name:"Договор об оказании услуг перевозки грузов от"}],d=$(n).attr("name");d.includes("new")&&(d=d.replace(/new/g,saveTableAndCard[1][1].length+1));for(let t=0;t<a.length;t++)for(let n=0;n<l.length;n++)a[t].Owner_type==e[0]&&e[0]==l[n].category&&a[t].Owner_id==d.split("_")[1]&&(i+=`\n                                <div class="contract flex" name="${l[n].name} ${a[t].Prefix}" id="${a[t].id}" onclick="downloadOldDocument(this)">\n                                    <div class="format">DOCX</div>\n                                    <div class="date_number">\n                                        <div class="top">${a[t].Creation_date}</div>\n                                        <div class="bottom">${a[t].MonthNum}/${a[t].Date}</div>\n                                    </div>\n                                    <span>${l[n].name} ${a[t].Prefix}</span>\n                                </div>\n                                `);$("#list_contract").empty(),$("#list_contract").append(i)}})}})}function downloadDocument(e){if(!confirm("Вы уверены, что Вы хотите создать новый договор?"))return;let t=$(e).attr("name").split("_");"new"==t[1]&&(t[1]=saveTableAndCard[1][1].length+1);let i=$("#select_cusmoter").val();"client"==t[0]?$.ajax({url:"/getClients",type:"GET",dataType:"html",success:function(n){n=JSON.parse(n);for(let a=0;a<n.length;a++)if(n[a].id==t[1]){let l;inputFieldDoc(t,l="ООО"==i?"Dogovor_na_tovari_ooo":"Dogovor_na_tovari_ip",n[a].Adress,e)}}}):"carrier"==t[0]&&$.ajax({url:"/getCarriers",type:"GET",dataType:"html",success:function(n){n=JSON.parse(n);for(let a=0;a<n.length;a++)if(n[a].id==t[1]){let l;inputFieldDoc(t,l="ООО"==i?"DogovorNaDostavkuOOO":"DogovorNaDostavkuIP",n[a].Address,e)}}})}function invoicingContentCard(e,t){function i(e,t,i){return $("<div>",{class:"row_card",id:"row_"+t,append:$("<div>",{class:"info_block full "+i,append:$("<table>",{class:"account_table new_table",id:t,html:e[0](),append:e[1]()})})})}return $("<div>",{class:"row_card",append:$("<div>",{class:"costs gray",html:' <div class="costs_element">\n                            <span>Всего затраты</span>\n                            <input type="text" onkeyup="maskNumberWithout(this.id); all_costs()"  id="total_costs_inv" class="total_count red bold mrl">\n                            <div name="unlock" class="lock_input" id="mode_costs" onclick="switchMode(this)"></div>\n                        </div> \n                        <div class="costs_element">\n                            <span>Скидка</span> \n                            <input type="text" onkeyup="calculationIndicators()" value="" onblur="dataСalculation(this)" id="total_discount_inv" class="total_count bold mrl">\n                            <div name="unlock" class="lock_input" id="mode_discount" onclick="switchMode(this)"></div>\n                        </div>\n                        <div class="costs_element">\n                            <span>Привет</span> \n                            <input type="text" onkeyup="maskNumberWithout(this.id); calculationIndicators()" value="" onblur="dataСalculation(this)" id="total_privet_inv" class="total_count bold mrl">\n                            <div name="unlock" class="lock_input" id="mode_privet" onclick="switchMode(this)"></div>\n                        </div>\n                        <div class="costs_element">\n                            <span>Доставка</span> \n                            <input type="text" onkeyup="maskNumberWithout(this.id); calculationIndicators()" value="" onblur="dataСalculation(this)" id="total_delivery_inv" class="total_count bold mrl">\n                            <div name="unlock" class="lock_input" id="mode_delivery" onclick="switchMode(this)"></div>\n                        </div>'})}).add(i([function(){return'<tr>\n                    <th width="15" rowspan="2"></th>\n                    <th width="150" rowspan="2">Товар</th>\n                    <th colspan="2">Фасовка</th>\n                    <th colspan="2">Количество</th>\n                    <th colspan="5">Цена, руб.</th>\n                    <th style="width: 90px;" rowspan="2">Сумма</th>\n                </tr>\n                <tr>\n                    <th>Вид</th>\n                    <th width="55">Вес, кг.</th>\n                    <th width="65">Всего, шт.</th>\n                    <th width="75">Объем, кг.</th>\n                    <th width="85">Цена прайса, руб.</th>\n                    <th width="60">Скидка</th>\n                    <th width="60">Привет</th>\n                    <th width="60">Доставка</th>\n                    <th width="75">За единицу</th>\n                </tr>'},function(e=""){let t=$("<tbody>",{id:"exposed_list"});for(let i=0;i<5;i++){let i=$("<tr>",{class:"product",id:"empty"});for(let t=0;t<12;t++)i.append($("<td>",{html:e}));t.append(i)}const i=["НДС","Без НДС","Общая"],n=["vat","without-vat","total"];for(let e=0;e<3;e++)t=t.add($("<tr>",{prepend:$("<td>",{colspan:10,css:{border:"none"}}),append:$("<td>",{colspan:2,class:"fz10",append:$("<div>",{class:"flex jc-sb",prepend:$("<span>",{class:"gray",html:i[e]}),append:$("<span>",{id:n[e]})})})}));return t}],"input_table","")).add('\n            <div class="search_items">\n                <input type="text" id="invoice_search_items">\n                <button onclick="searchItemsInTable()" class="btn btn-main btn-srch btn-srch-left">Поиск</button>\n            </div>\n        ').add(i([function(){return"<tr>\n                    <th>Группа товаров</th>\n                    <th>Товар</th>\n                    <th>Юр. лицо</th>\n                    <th>Объем, кг.</th>\n                    <th>Фасовка</th>\n                    <th>НДС</th>\n                    <th>Цена прайса, руб.</th>\n                    <th>Склад</th>\n                </tr>"},function(){let e=$("<tbody>",{id:"filter_list"});for(let i=0;i<t.length;i++)if(null!==t[i].stock_address)for(let n=0;n<t[i].items.length;n++){let a=$("<tr>",{onclick:"invoiceInTable(this)",id:`invoice_${t[i].items[n].Item_id}`});const l=[t[i].items[n].Group_name,t[i].items[n].Name,t[i].items[n].Prefix,returnSpaces(t[i].items[n].Volume),t[i].items[n].Packing,t[i].items[n].NDS,returnSpaces(t[i].items[n].Cost),t[i].stock_address];for(let e=0;e<l.length;e++)a.append($("<td>",{html:l[e]}));e.append(a)}return e}],"output_table","hmax")).add($("<div>",{class:"next",prepend:$("<button>",{class:"btn",id:e.id+"-inv",onclick:"comeBack(this.id)",html:"Назад"}),append:$("<button>",{class:"btn btn-main",id:"account",name:e.id,data_name:e.name,onclick:"completionCard(this)",html:"Выставить"})}))}function searchItemsInTable(){let e=$("#invoice_search_items").val();$.ajax({url:"/getStockTable",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t);let i=$("<div>",{class:"info_block full hmax",append:$("<table>",{class:"account_table new_table",id:"output_table",html:"<tr>\n                            <th>Группа товаров</th>\n                            <th>Товар</th>\n                            <th>Юр. лицо</th>\n                            <th>Объем, кг.</th>\n                            <th>Фасовка</th>\n                            <th>НДС</th>\n                            <th>Цена прайса, руб.</th>\n                            <th>Склад</th>\n                        </tr>",append:function(){let i=$("<tbody>",{id:"filter_list"});for(let n=0;n<t.length;n++)if(null!==t[n].stock_address)for(let a=0;a<t[n].items.length;a++)if(t[n].items[a].Name.includes(e)){let e=$("<tr>",{onclick:"invoiceInTable(this)",id:`invoice_${t[n].items[a].Item_id}`});const l=[t[n].items[a].Group_name,t[n].items[a].Name,t[n].items[a].Prefix,t[n].items[a].Volume,t[n].items[a].Packing,t[n].items[a].NDS,t[n].items[a].Cost,t[n].stock_address];for(let t=0;t<l.length;t++)e.append($("<td>",{html:l[t]}));i.append(e)}return i}()})});$("#row_output_table").empty(),$("#row_output_table").append(i)}})}function addItemToAccount(e){$.ajax({url:"/getStockTable",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t);let i=null,n=$("#exposed_list .invoiled").attr("id");if(null!=n){n=n.split("_")[1];for(let e=0;e<t.length;e++)for(let a=0;a<t[e].items.length;a++){let l=t[e].items[a];l.Item_id==n&&(i=l.Prefix)}}else for(let n=0;n<t.length;n++)for(let a=0;a<t[n].items.length;a++){let l=t[n].items[a];l.Item_id==e.id.split("_")[1]&&(i=l.Prefix)}let a=$("<tr>",{class:"product invoiled",id:`product_${e.id.split("_")[1]}`});for(let n=0;n<t.length;n++)for(let l=0;l<t[n].items.length;l++){let d=t[n].items[l];if(d.Prefix==i&&d.Item_id==e.id.split("_")[1]){a.append($("<td>",{id:`invoiled_${e.id.split("_")[1]}`,onclick:"deleteProduct(this.id)",append:$("<img>",{src:"../static/images/returnBack.png",width:12})}));let t=e.id.split("_")[1],i=[{id:"",html:d.Name},{id:"",html:d.Packing},{id:`product_weight_${t}`,html:returnSpaces(d.Weight)},{id:`product_containers_${t}`,html:""},{id:`invoiled_volume_${t}`,html:""},{id:`product_cost_${t}`,html:returnSpaces(d.Cost)},{id:`calcSale_${t}`,html:""},{id:`calcPrivet_${t}`,html:""},{id:`calcDelivery_${t}`,html:""},{id:`product_unit_${t}`,html:""},{id:`amountC_${t}`,html:""}];for(let e=0;e<i.length;e++)i[e].id.includes("invoiled_volume")?a.append($("<td>",{append:$("<input>",{type:"text",onkeyup:"maskNumberWithout(this.id); tarCalculation(this.id)",id:i[e].id,max:d.Volume})})):i[e].id.includes("calc")?a.append($("<td>",{append:$("<input>",{type:"text",id:i[e].id,name:"edit",onkeyup:"maskNumber(this.id); recountPrice(this)"})})):a.append($("<td>",{id:i[e].id,html:i[e].html}));$(`#${e.id}`).remove(),$("#empty").last().remove(),$("#exposed_list").prepend(a);let n=0;$("#exposed_list .invoiled #amount_product").each(function(e,t){n+=+deleteSpaces($(t).html())}),d.NDS=d.NDS[0]+d.NDS[1];let l=n>0?n-n*+d.NDS/100:0;$("#total").html(returnSpaces(Math.round(n))),$("#vat").html(returnSpaces(Math.round(n-l))),$("#without-vat").html(returnSpaces(Math.round(l)));break}}calculationIndicators()}})}function invoiceInTable(e){$.ajax({url:"/getStockTable",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t);let i=null,n=$("#exposed_list .invoiled").attr("id");if(null!=n){n=n.split("_")[1];for(let e=0;e<t.length;e++)for(let a=0;a<t[e].items.length;a++){let l=t[e].items[a];l.Item_id==n&&(i=l.Prefix)}}else for(let n=0;n<t.length;n++)for(let a=0;a<t[n].items.length;a++){let l=t[n].items[a];l.Item_id==e.id.split("_")[1]&&(i=l.Prefix)}let a=$("<tr>",{class:"product invoiled",id:`invoiled_${e.id.split("_")[1]}_product`});for(let n=0;n<t.length;n++)for(let l=0;l<t[n].items.length;l++){let d=t[n].items[l];if(d.Prefix==i&&d.Item_id==e.id.split("_")[1]){a.append($("<td>",{id:`invoiled_${e.id.split("_")[1]}`,onclick:"returnBack(this)",append:$("<img>",{src:"../static/images/returnBack.png",width:12})}));let t=e.id.split("_")[1],i=[{id:"",html:d.Name},{id:"",html:d.Packing},{id:`product_weight_${t}`,html:returnSpaces(d.Weight)},{id:`product_containers_${t}`,html:""},{id:`invoiled_volume_${t}`,html:""},{id:`product_cost_${t}`,html:returnSpaces(d.Cost)},{id:`calcSale_${t}`,html:""},{id:`calcPrivet_${t}`,html:""},{id:`calcDelivery_${t}`,html:""},{id:`product_unit_${t}`,html:""},{id:`amountC_${t}`,html:""}];for(let e=0;e<i.length;e++)i[e].id.includes("invoiled_volume")?a.append($("<td>",{append:$("<input>",{type:"text",onkeyup:"maskNumberWithout(this.id); tarCalculation(this.id)",id:i[e].id,max:d.Volume})})):i[e].id.includes("calc")?a.append($("<td>",{append:$("<input>",{type:"text",id:i[e].id,name:"create",onkeyup:"recountPrice(this)"})})):a.append($("<td>",{id:i[e].id,html:i[e].html}));$(`#${e.id}`).remove(),$("#empty").last().remove(),$("#exposed_list").prepend(a);let n=0;$("#exposed_list .invoiled #amount_product").each(function(e,t){n+=+deleteSpaces($(t).html())}),d.NDS=d.NDS[0]+d.NDS[1];let l=n>0?n-n*+d.NDS/100:0;$("#total").html(returnSpaces(Math.round(n))),$("#vat").html(returnSpaces(Math.round(n-l))),$("#without-vat").html(returnSpaces(Math.round(l)));break}}calculationIndicators()}})}function dataСalculation(e){for(let t=0;t<list_inv.length;t++)list_inv[t].id==e.id&&(list_inv[t].value=$(e).val());let t=+Math.abs(deleteSpaces($("#total_discount_inv").val()))+ +deleteSpaces($("#total_privet_inv").val())+ +deleteSpaces($("#total_delivery_inv").val());$("#total_costs_inv").val(returnSpaces(t));let i=deleteSpaces($("#total_costs_inv").val()),n=0;for(let e of $("#exposed_list .invoiled"))n++;for(let e of $("#exposed_list .invoiled"))$(e).children()[11].innerHTML=returnSpaces(+deleteSpaces($(e).children()[5].children[0].value)*+deleteSpaces($(e).children()[6].innerHTML)+Math.ceil(+i/+n));calculationIndicators()}let currentVatValue=0;function calculationIndicators(){let e=[{id:"total_discount_inv",tr:"calcSale"},{id:"total_privet_inv",tr:"calcPrivet"},{id:"total_delivery_inv",tr:"calcDelivery"}],t=0;$("#exposed_list .invoiled").each(function(e,i){t++});for(let i=0;i<e.length;i++){let e=categoryInStock[1][1];for(let i=0;i<e.length;i++)for(let n=0;n<e[i].items.length;n++)$("#exposed_list .invoiled").each(function(a,l){if($(l).attr("id").split("_")[1]==e[i].items[n].Item_id){let a=(+deleteSpaces($("#total_discount_inv").val())/+deleteSpaces($(`#invoiled_volume_${e[i].items[n].Item_id}`).val())/t).toFixed(2),l=(+deleteSpaces($("#total_privet_inv").val())/+deleteSpaces($(`#invoiled_volume_${e[i].items[n].Item_id}`).val())/t).toFixed(2),d=(+deleteSpaces($("#total_delivery_inv").val())/+deleteSpaces($(`#invoiled_volume_${e[i].items[n].Item_id}`).val())/t).toFixed(2),s=(-1*+a+ +l+ +d+ +deleteSpaces($(`#product_cost_${e[i].items[n].Item_id}`).html())).toFixed(2);$(`#calcSale_${e[i].items[n].Item_id}`).val(isNaN(a)||a==1/0||a==-1/0?"":returnSpaces((-1*+a).toFixed(2))),$(`#calcPrivet_${e[i].items[n].Item_id}`).val(isNaN(l)||l==1/0||l==-1/0?"":returnSpaces(l)),$(`#calcDelivery_${e[i].items[n].Item_id}`).val(isNaN(d)||d==1/0||d==-1/0?"":returnSpaces(d)),$(`#product_unit_${e[i].items[n].Item_id}`).html(isNaN(s)||s==1/0||s==-1/0?"":returnSpaces(s));let c=deleteSpaces((+deleteSpaces($(`#calcDelivery_${e[i].items[n].Item_id}`).val())+ +deleteSpaces($(`#calcPrivet_${e[i].items[n].Item_id}`).val())+ +deleteSpaces($(`#calcSale_${e[i].items[n].Item_id}`).val()))*+deleteSpaces($(`#invoiled_volume_${e[i].items[n].Item_id}`).val())),o=deleteSpaces(Math.round(+deleteSpaces($(`#product_cost_${e[i].items[n].Item_id}`).html())*+deleteSpaces($(`#invoiled_volume_${e[i].items[n].Item_id}`).val())).toFixed(2));$(`#amountC_${e[i].items[n].Item_id}`).html(returnSpaces(+o+c));let r=0;for(let e of $("#exposed_list .invoiled"))r+=+deleteSpaces($(e).children()[11].innerHTML);e[i].items[n].NDS=e[i].items[n].NDS[0]+e[i].items[n].NDS[1];let p=r>0?deleteSpaces(r-r*+e[i].items[n].NDS/100):0;currentVatValue=+e[i].items[n].NDS,$("#total").html(returnSpaces(Math.round(r))),$("#vat").html(returnSpaces(Math.round(r-p))),$("#without-vat").html(returnSpaces(Math.round(p)))}})}}function tarCalculation(e){let t=e.split("_")[2],i=+deleteSpaces($(`#${e}`).val()),n=+deleteSpaces($(`#product_weight_${t}`).html()),a=Math.round(+deleteSpaces($(`#product_cost_${t}`).html())+ +deleteSpaces($(`#calcSale_${t}`).val())+ +deleteSpaces($(`#calcPrivet_${t}`).val())+ +deleteSpaces($(`#calcDelivery_${t}`).val())).toFixed(2);$(`#product_containers_${t}`).html(returnSpaces(Math.floor(i/n))),$(`#product_unit_${t}`).html(a==1/0||isNaN(a)?"0":returnSpaces(a)),calculationIndicators()}function recountPrice(e){let t,i=e.id.split("_");(t="create"==$(e).attr("name")?$(`#exposed_list #invoiled_${i[1]}_product`):$(`#exposed_list #product_${i[1]}`)).children().last().html(returnSpaces(+deleteSpaces(t.children()[5].children[0].value)*+deleteSpaces(t.children()[6].innerHTML)+(+deleteSpaces(t.children()[7].children[0].value)*+deleteSpaces(t.children()[5].children[0].value)+ +deleteSpaces(t.children()[8].children[0].value)*+deleteSpaces(t.children()[5].children[0].value)+ +deleteSpaces(t.children()[9].children[0].value)*+deleteSpaces(t.children()[5].children[0].value))));let n=[{id:"total_discount_inv",type:"calcSale"},{id:"total_privet_inv",type:"calcPrivet"},{id:"total_delivery_inv",type:"calcDelivery"}];for(let e=0;e<n.length;e++)if(i[0].includes(n[e].type)){let a=0;$("#exposed_list .invoiled").each(function(e,t){let n=""==+deleteSpaces($(`#${i[0]}_${i[1]}`).val())?0:+deleteSpaces($(`#${i[0]}_${i[1]}`).val()),l=""==+deleteSpaces($(`#invoiled_volume_${i[1]}`).val())?0:+deleteSpaces($(`#invoiled_volume_${i[1]}`).val());a+=n*l}),"total_discount_inv"==n[e].id&&(a*=-1),$(`#${n[e].id}`).val(returnSpaces(a)),$(`#product_unit_${i[1]}`).html(returnSpaces(+deleteSpaces(t.children()[6].innerHTML)+ +deleteSpaces(t.children()[7].children[0].value)+ +deleteSpaces(t.children()[8].children[0].value)+ +deleteSpaces(t.children()[9].children[0].value)))}let a=0;$("#exposed_list .invoiled").each(function(e,t){a+=+deleteSpaces($(t).children()[11].innerHTML)});let l=categoryInFinanceAccount[1][1];for(let e=0;e<l.length;e++)for(let t=0;t<l[e].items.length;t++)if(l[e].items[t].Item_id==i[1]){let i=a>0?a-a*+l[e].items[t].NDS/100:0;$("#total").html(returnSpaces(Math.round(a))),$("#vat").html(returnSpaces(Math.round(a-i))),$("#without-vat").html(returnSpaces(Math.round(i)));break}let d=+Math.abs(deleteSpaces($("#total_discount_inv").val()))+ +deleteSpaces($("#total_privet_inv").val())+ +deleteSpaces($("#total_delivery_inv").val());$("#total_costs_inv").val(returnSpaces(d))}function all_costs(){let e=3,t=0;for(let i=0;i<list_inv.length;i++)list_inv[i].disable&&(e--,t+=+deleteSpaces($(`#${list_inv[i].id}`).val()));let i=+deleteSpaces($("#total_costs_inv").val())-t;if("string"==typeof i)return;let n=Math.round(i/e);for(let e=0;e<list_inv.length;e++)list_inv[e].disable||$(`#${list_inv[e].id}`).val(returnSpaces(n));for(let e of $("#exposed_list .invoiled"))$(e).children()[11].innerHTML=returnSpaces(+deleteSpaces($(e).children()[5].children[0].value)*+deleteSpaces($(e).children()[6].innerHTML)+(+deleteSpaces($(e).children()[7].children[0].value)*+deleteSpaces($(e).children()[5].children[0].value)+ +deleteSpaces($(e).children()[8].innerHTML)*+deleteSpaces($(e).children()[5].children[0].value)+ +deleteSpaces($(e).children()[9].innerHTML)*+deleteSpaces($(e).children()[5].children[0].value)));calculationIndicators()}function returnBack(e){$.ajax({url:"/getStockTable",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t),$(`#${e.id}_product`).remove();let i=$("<tr>",{onclick:"invoiceInTable(this)",id:e.id.replace(/invoiled_/g,"invoice_")});for(let n=0;n<t.length;n++)for(let a=0;a<t[n].items.length;a++){let l=t[n].items[a];if(l.Item_id==e.id.split("_")[1]){let e=[l.Group_name,l.Name,l.Prefix,l.Volume,l.Packing,l.NDS,l.Cost,t[n].stock_address];for(let t=0;t<e.length;t++)i.append($("<td>",{html:e[t]}));let a=0;$("#exposed_list .invoiled").each(function(e,t){a+=+deleteSpaces($(t).children()[11].innerHTML)}),l.NDS=l.NDS[0]+l.NDS[1];let d=a>0?a-a*+l.NDS/100:0;$("#total").html(returnSpaces(Math.round(a))),$("#vat").html(returnSpaces(Math.round(a-d))),$("#without-vat").html(returnSpaces(Math.round(d)));break}}$("#filter_list").append(i);let n=$("<tr>",{class:"product",id:"empty"});for(let e=0;e<12;e++)n.append($("<td>",{html:""}));$("#exposed_list").append(n),calculationIndicators()}})}let list_inv=[{disable:!1,id:"total_discount_inv",value:0},{disable:!1,id:"total_privet_inv",value:0},{disable:!1,id:"total_delivery_inv",value:0}];function switchMode(e){let t=$(`#${e.id.replace(/mode_/g,"total_")}_inv`);if("lock"==$(e).attr("name")){$(e).css("background-image","url(static/images/unlc.svg)"),$(e).attr("name","unlock"),t.removeAttr("disabled"),t.removeClass("disable");for(let e=0;e<list_inv.length;e++)list_inv[e].id==t[0].id&&(list_inv[e].disable=!1)}else if("unlock"==$(e).attr("name"))if($(e).css("background-image","url(static/images/lock.svg)"),$(e).attr("name","lock"),t.attr("disabled","disabled"),t.addClass("disable"),""==$("#total_costs_inv").val()){let e=0;for(let t=0;t<list_inv.length;t++)e+=+deleteSpaces($(`#${list_inv[t].id}`).val());$("#total_costs_inv").val(e)}else{let e=0;for(let e=0;e<list_inv.length;e++)list_inv[e].id==t[0].id&&(list_inv[e].disable=!0);let i=3;for(let t=0;t<list_inv.length;t++)list_inv[t].disable&&(i--,e+=+deleteSpaces($(`#${list_inv[t].id}`).val()));let n=+deleteSpaces($("#total_costs_inv").val())-e;if("string"==typeof n)return;let a=Math.round(n/i);for(let e=0;e<list_inv.length;e++)list_inv[e].disable||$(`#${list_inv[e].id}`).val(a)}for(let e=0;e<list_inv.length;e++)list_inv[e].value=deleteSpaces($(`#${list_inv[e].id}`).val());calculationIndicators()}function addComment(e="",t,i=!1){if(""===e){$("#messages").empty(),$("#comments").empty();let e=[];$("#member .member").each(function(t,i){""!=$(i).children()[0].children[0].children[0].value&&e.push({role:$(i).children()[0].children[0].children[0].value,surname:$(i).children()[0].children[0].children[2].value})}),$("#messages").prepend($("<tr>",{id:"message",append:`\n                    <td>\n                        <input type="text" onchange="saveCard()" value="${getCurrentDateNotComparison("year")}" id="comment_date" class="m_date">\n                    </td>\n                    <td>\n                        <select onselect="saveCard()" id="comment_role" class="m_role">\n                            <option value="Не указано" selected disabled>Не указано</option>\n                            ${function(){let t="";for(let t=0;t<e.length-1;t++)for(let i=t+1;i<e.length;i++)e[t].role===e[i].role&&e[t].surname==e[i].surname&&(e.splice(i,1),i--);for(let i=0;i<e.length;i++)t=t.concat(`<option value="${e[i].role} | ${e[i].surname}">${e[i].role} | ${e[i].surname}</option>`);return t}()}\n                        <select>\n                    </td>`})),$("#comments").append($("<tr>",{id:"comment",append:'\n                    <td>\n                        <textarea class="m_comment" id="comment_content" onchange="saveCard()"></textarea>\n                    </td>'})),$("#comment_date").datepicker({position:"right bottom",autoClose:!0})}else $("#messages").prepend($("<tr>",{id:"message",append:`\n                    <td width="75">\n                        <div type="text" id="message_date" class="m_date">${e.date}</div>\n                    </td>\n                    <td style="padding-bottom: 10px">\n                        <div type="text" onclick="showThisComment(this)" id="comments_${t[0]}_${t[1]}_${e.id}" class="m_role static">${e.name}</div>\n                    </td>\n                    <td width="75"><p style="width: 85px;" class="clip">${e.note}</p></td>`})),i&&$("#comments").prepend($("<tr>",{id:"comment",append:`\n                        <td>\n                            <div class="done"><p style="width: 95%;">${e.note}</p></div>\n                        </td>\n                        <td style="font-weight: 500;" width="100">${null==e.creator?"Не определен":e.creator}</td>\n                    `}))}function showThisComment(e){$("#comments").empty();let t=e.id.split("_");$.ajax({url:"/getMessages",type:"GET",data:{category:t[1],id:t[2]},dataType:"html",success:function(e){!function(e){for(let i=0;i<e.length;i++)if(+t[3]==+e[i].NoteId){let t={comment:e[i].Note,creator:null==e[i].Creator?"Не определен":e[i].Creator};$("#comments").prepend($("<tr>",{id:"comment",append:`\n                            <td>\n                                <div class="done"><p style="width: 95%;">${t.comment}</p></div>\n                            </td>\n                            <td style="font-weight: 500;" width="100">${t.creator}</td>\n                        `}))}}(JSON.parse(e))}})}function showOrHideInfo(e){let t="hidden_info_"+e,i="hidden_image_"+e;$(`#${i}`).hasClass("drop_active")?($(`#${i}`).removeClass("drop_active"),$(`#${t}`).fadeOut(200)):($(`#${i}`).addClass("drop_active"),$(`#${t}`).fadeIn(200))}function addMember(e="client",t=""){""==t&&(t={role:"",Number:"",Phone_two:"",Last_name:"",Name:"",Email:"",Car:"",visible:!0}),category="carrier"===e?{class:"car",member:"delivery",placeholder:"Транспорт",select:t.Car}:{class:"phone",member:"",placeholder:"Телефон #1",select:t.Number};let i=0;$("#member .member").each(function(e,t){i++}),$("#member").prepend($("<div>",{class:`member ${category.member}`,id:`member_${i}`,append:$("<div>",{class:"m_info",append:$("<div>",{class:"top",append:$("<select>",{css:{"margin-top":"10px"},append:function(){let e,i='<option disabled selected value="Не выбрана">Должность</option>';$.ajax({url:"/getRoles",type:"GET",dataType:"html",async:!1,success:function(t){e=JSON.parse(t)}});for(let n=0;n<e.length;n++)t.Position==e[n].Name?i+=`<option selected value="${e[n].Name}">${e[n].Name}</option>`:i+=`<option value="${e[n].Name}">${e[n].Name}</option>`;return i}()}).add(`\n                     <input placeholder="Фамилия" class="last_name" id="last_name" onchange="saveCard()" value="${null==t.Last_name?"":t.Last_name}" type="text">\n                     <input placeholder="Имя Отчество" class="first_name" id="first_name" onchange="saveCard()" value="${null==t.Name?"":t.Name}" type="name">\n                     <input placeholder="${category.placeholder}" class="${category.class}" id="${category.class}" onchange="saveCard()" value="${category.select}">\n                     ${"carrier"===e?`<input placeholder="Телефон #1" class="phone" id="phone" onchange="saveCard()" value="${t.Number}">\n                    <input placeholder="Телефон #2" class="phone" id="phone_two" onchange="saveCard()" value="${t.Phone_two}">`:`<input placeholder="Телефон #2" class="phone" id="phone_two" onchange="saveCard()" value="${t.Phone_two}">`}\n                     <input placeholder="Почта" class="email" id="email" onchange="saveCard()" onblur="checkEmail()" value="${null==t.Email?"":t.Email}" type="email">\n                    `)})}).add($("<div>",{class:"visible",id:`visible_${i}`,onclick:"visOrHidContact(this.id)",append:$("<img>",{src:"../static/images/visible.png"})}))})),null==t.Visible&&(t.Visible=!0),t.Visible||visOrHidContact(`visible_${i}`);for(let e of $("#member .member #phone"))$(e).mask("8-999-999-99-99");for(let e of $("#member .member #phone_two"))$(e).mask("8-999-999-99-99");saveCard()}function visOrHidContact(e){let t=e.split("_");if("visible"==t[0]){$(`#${e}`).attr("id",`hidden_${t[1]}`),$(`#member_${t[1]}`).addClass("hidden"),$(`#member_${t[1]} #role`).attr("disabled","disabled"),$(`#member_${t[1]} #phone`).attr("disabled","disabled"),$(`#member_${t[1]} #phone_two`).attr("disabled","disabled"),$(`#member_${t[1]} #car`).attr("disabled","disabled"),$(`#member_${t[1]} #last_name`).attr("disabled","disabled"),$(`#member_${t[1]} #first_name`).attr("disabled","disabled"),$(`#member_${t[1]} #email`).attr("disabled","disabled"),$(`#hidden_${t[1]}`).empty(),$(`#hidden_${t[1]}`).append($("<img>",{src:"../static/images/hidden.png"}));let i=$(`#member_${t[1]}`).remove();$("#member").append(i)}else{$(`#${e}`).attr("id",`visible_${t[1]}`),$(`#member_${t[1]}`).removeClass("hidden"),$(`#member_${t[1]} #role`).removeAttr("disabled"),$(`#member_${t[1]} #car`).removeAttr("disabled"),$(`#member_${t[1]} #phone`).removeAttr("disabled"),$(`#member_${t[1]} #phone_two`).removeAttr("disabled"),$(`#member_${t[1]} #last_name`).removeAttr("disabled"),$(`#member_${t[1]} #first_name`).removeAttr("disabled"),$(`#member_${t[1]} #email`).removeAttr("disabled"),$(`#visible_${t[1]}`).empty(),$(`#visible_${t[1]}`).append($("<img>",{src:"../static/images/visible.png"}));let i=$(`#member_${t[1]}`).remove();$("#member").prepend(i)}}function checkEmail(){let e=[];$("#member .member").each(function(t,i){let n=$(i).children().children().children().last()[0],a=n.value;if(""==a)return e.push("true"),!1;null==a.match(/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/)?($(n).addClass("wrong_input"),setTimeout(function(){$(n).removeClass("wrong_input")},2250),e.push("false")):e.push("true")});for(let t=0;t<e.length;t++)if("false"==e[t])return!1;return!0}function deleteSpaces(e){return"string"!=typeof e?e:e.replace(/\s/g,"")}function removeMemberOrRow(e){e=e.split("_")[2],$(`#${e}`).children().last().remove(),$(`#${e}`).children().length<=1&&$(`[name="remove_last_${e}"]`).fadeOut(0)}function maskNumber(e){$(`#${e}`).mask("# ##0.00",{reverse:!0})}function maskNumberWithout(e){$(`#${e}`).mask("# ##0",{reverse:!0})}function returnSpaces(e){let t=e=deleteSpaces(e=String(e)),i=0,n=[];e.includes(".")&&(t=e.split(".")[0]);for(let e=t.length-1;e>=0;e--)if(n.push(t[e]),++i%3==0){if("-"==t[e-1]){n.push("-");break}n.push(" ")}return e.includes(".")&&"00"!=e.split(".")[1]?n.reverse().join("").trim()+"."+e.split(".")[1]:n.reverse().join("").trim()}function changeSearchMode(e){let t=[{id:"active_comment_seach",txt:"Введите текст комментария"},{id:"active_comment_seach_name",txt:"Введите наименование организации"}];for(let i=0;i<t.length;i++)if(t[i].id==e){$(`#${e}`).prop("checked")?($("input:checked").prop("checked",!1),$(`#${e}`).prop("checked",!0),$("#search").attr("placeholder",t[i].txt)):($(`#${e}`).prop("checked",!1),$("#search").attr("placeholder","Введите фамилию, телефон или email"));break}}function visibleSelectPeriod(e="account"){$("div").is(".period_info_accounts")?$(".period_info_accounts").remove():$("#select_period_info_accounts").append(`\n            <div class="period_info_accounts">\n                <ul>\n                    <li id="day" onclick="selectPeriod(this.id, '${e}')">за последний день</li>\n                    <li id="weak" onclick="selectPeriod(this.id, '${e}')">за последнюю неделю</li>\n                    <li id="month" onclick="selectPeriod(this.id, '${e}')">за последний месяц</li>\n                    <li id="year" onclick="selectPeriod(this.id, '${e}')">за последний год</li>\n                    <li id="all" onclick="selectPeriod(this.id, '${e}')">за все время</li>\n                </ul>\n            </div>\n        `)}function selectPeriod(e="month",t){if($("div").is(".card_menu"))return;let i=[{id:"account",request:"/getAccounts"},{id:"delivery",request:"/getDeliveries"},{id:"provider",request:"/getProviders"}];let n=function(){for(let e=0;e<i.length;e++)if(i[e].id==t)return i[e].request}();$.ajax({url:n,type:"GET",dataType:"html",beforeSend:function(){$("body").prepend('\n                <div id="preloader">\n                    <div id="preloader_preload"></div>\n                </div>\n            '),preloader=document.getElementById("preloader_preload")},success:function(t){account_data=JSON.parse(t);let i=function(){let t=[{id:"day",period:0,text:"за последний день"},{id:"weak",period:7,text:"за последнюю неделю"},{id:"month",period:30,text:"за последний месяц"},{id:"year",period:365,text:"за последний год"},{id:"all",period:5475,text:"за все время"}];for(let i=0;i<t.length;i++)if(e==t[i].id){let e=getCurrentDate("year"),n=/(\d\d)\.(\d\d)\.(\d\d)/,a=n.exec(e),l=new Date("20"+ +a[3],+a[2],a[1]),d=new Date("20"+ +a[3],+a[2],a[1]);return d.setDate(d.getDate()-t[i].period),$("#period_accounts").html(t[i].text),[d,l]}}();let n=[],a=[{id:"debit",table:filterDebit,date:"account"},{id:"account",table:filterAccount,date:"account"},{id:"delivery",table:filterDelivery,date:"delivery"},{id:"provider",table:filterProvider,date:""}];for(let e=0;e<account_data.length;e++){function l(){for(let t=0;t<a.length;t++){if(a[t].id.includes("provider"))return null==account_data[e].Create_date&&(account_data[e].Create_date="01.01.20"),getValidationDate(account_data[e].Create_date);if(saveTableAndCard[0].id.includes(a[t].id))return getValidationDate(account_data[e][a[t].date].Date)}}let t=l();t>=i[0]&&t<=i[1]&&n.push(account_data[e])}let d=function(){for(let e=0;e<a.length;e++)if(saveTableAndCard[0].id.includes(a[e].id))return a[e].table}();d[1][1]=[],d[1][1]=n,$(".period_info_accounts").remove(),$(".table").remove(),$(".info").append(fillingTables(d))},complete:function(){setTimeout(function(){fadeOutPreloader(preloader)},0)}})}function selectThisProvider(e){let t=$(e).html();$(e).parent().parent().parent().children()[0].value=t}function contextualSearch(e){$.ajax({url:"/getProviders",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t).reverse();let i=$(e).parent(),n=e.id.split("_")[2];i.append(`\n                <div class="context_search hmax" id="search_${n}">\n                    <ul id="list_providers_for_search">\n                        ${function(){let e="";for(let i=0;i<t.length;i++)e+=`<li id="${t[i].id}" onclick="selectThisProvider(this)">${t[i].Name}</li>`;return e}()}\n                    </ul>\n                </div>\n            `),searchWord(e.value)}})}function searchWord(e){$.ajax({url:"/getProviders",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t).reverse(),$("#list_providers_for_search").empty();for(let i=0;i<t.length;i++){let n=t[i].Name.toLowerCase(),a=e.toLowerCase();n.includes(a)&&$("#list_providers_for_search").append(`\n                        <li id="${t[i].id}" onclick="selectThisProvider(this)">${t[i].Name}</li>\n                    `)}""==$("#list_providers_for_search").html()&&$("#list_providers_for_search").append("\n                    <span>Ничего не найдено</span>\n                ")}})}function hiddenSearch(e){setTimeout(function(){let t=e.id.split("_")[2];$(`#search_${t}`).remove()},150)}function addRow(e,t=""){const i=[{id:"client-group",tbody:"group",count:4,widthInput:[{id:"item_product",width:210,type:"text"},{id:"item_volume",width:65,type:"text"},{id:"item_creator",width:225,type:"text"},{id:"item_price",width:90,type:"text"}],html:["Name","Volume","Creator","Cost"]},{id:"provider-group",tbody:"group",count:7,widthInput:[{id:"item_product",width:210,type:"text"},{id:"item_price",width:90,type:"text"},{id:"item_date",width:70,type:"text"},{id:"item_vat",width:30,type:"number"},{id:"item_packing",width:100,type:"text"},{id:"item_weight",width:65,type:"text"},{id:"item_fraction",width:90,type:"text"}],html:["Name","Cost","Date","NDS","Packing","Weight","Fraction"]},{id:"carrier-group",tbody:"group",count:5,widthInput:[{id:"carrier_date",width:50,type:"text"},{id:"carrier_client",width:100,type:"text"},{id:"carrier_stock",width:160,type:"text"},{id:"carrier_driver",width:90,type:"text"},{id:"carrier_price",width:80,type:"text"}],html:[]},{id:"account-group",tbody:"group",count:2,widthInput:[{id:"account_date",width:70,type:"text"},{id:"account_price",width:90,type:"text"}],html:["date","sum"]},{id:"delivery-group",tbody:"group",count:2,widthInput:[{id:"delivery_date",width:70,type:"text"},{id:"delivery_price",width:90,type:"text"}],html:["date","price"]},{id:"flight-group",tbody:"flight",count:6,widthInput:[{id:"delivery_flight_product",width:100,type:"text"},{id:"delivery_flight_stock",width:160,type:"text"},{id:"delivery_flight_weight",width:65,type:"text"},{id:"delivery_flight_type",width:160,type:"text"},{id:"delivery_flight_sum",width:90,type:"text"}],html:[]}];function n(i){let n=$("<tr>");function a(e){$.ajax({url:"/getAllItems",type:"GET",dataType:"html",success:function(i){let n='<option value="disabled" selected disabled>Выбрать</option>',a=["Россыпь","Ракушка","Гранулы"];for(let e=0;e<a.length;e++)n+=`<option value="${a[e]}">${a[e]}</option>`;$(`#${e}`).empty(),$(`#${e}`).append(n),$('.hmax #group [name="item_fraction"]').each(function(){""==t.Fraction?$(`#${e} option:contains('Выбрать')`).attr("selected",!0):($(`#${e} option`).each(function(e,i){$(i).html()==t.Fraction&&$(i).attr("selected",!0)}),$(`#${e} :selected`).val($(`#${e} :selected`).html()))})}})}function l(e){$.ajax({url:"/getAllItems",type:"GET",dataType:"html",success:function(){let i='<option value="disabled" selected disabled>Выбрать</option>',n=["Насыпь","Мешки","ББ"];for(let e=0;e<n.length;e++)i+=`<option value="${n[e]}">${n[e]}</option>`;$(`#${e}`).empty(),$(`#${e}`).append(i),$('.hmax #group [name="item_packing"]').each(function(){""==t.Packing?$(`#${e} option:contains('Выбрать')`).attr("selected",!0):($(`#${e} option`).each(function(e,i){$(i).html()==t.Packing&&$(i).attr("selected",!0)}),$(`#${e} :selected`).val($(`#${e} :selected`).html()))})}})}for(let d=0;d<i.count;d++)if("item_product"==i.widthInput[d].id){let a=0;$('.hmax #group [name="items_list"]').each(function(){a++}),n.append($("<td>",{append:$("<select>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:"item_product_"+a,name:"items_list",append:getItemsList("item_product_"+a,t,e.split("-")[0])})}))}else if("item_creator"==i.widthInput[d].id){let e=0;$('.hmax #group [name="items_creator"]').each(function(){e++}),n.append($("<td>",{append:$("<input>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:"item_creator_"+e,name:"items_creator",value:t[i.html[d]],onfocus:"contextualSearch(this)",onblur:"hiddenSearch(this)",onkeyup:"searchWord(this.value)",autocomplete:"off"})}))}else if("item_packing"==i.widthInput[d].id){let e=0;$('.hmax #group [name="item_packing"]').each(function(){e++}),n.append($("<td>",{append:$("<select>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:"item_packing_"+e,name:"item_packing",append:l("item_packing_"+e)})}))}else if("item_fraction"==i.widthInput[d].id){let e=0;$('.hmax #group [name="item_fraction"]').each(function(){e++}),n.append($("<td>",{append:$("<select>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:"item_fraction_"+e,name:"item_fraction",append:a("item_fraction_"+e)})}))}else i.widthInput[d].id.includes("sum")||i.widthInput[d].id.includes("weight")||i.widthInput[d].id.includes("price")?n.append($("<td>",{append:$("<input>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:i.widthInput[d].id,value:t[i.html[d]],type:i.widthInput[d].type,onkeyup:"maskNumber(this.id)"})})):n.append($("<td>",{append:$("<input>",{css:{width:i.widthInput[d].width+"px",padding:"0"},id:i.widthInput[d].id,value:t[i.html[d]],type:i.widthInput[d].type})}));return n}for(let t=0;t<i.length;t++)e==i[t].id&&($(`#${i[t].tbody}`).append(n(i[t])),$('[name="remove_last_group"]').fadeIn(0),"client-group"===e&&($("#group #item_price").mask("# ##0.00",{reverse:!0}),$("#group #item_volume").mask("# ##0.00",{reverse:!0})),"provider-group"===e&&($("#group #item_price").mask("# ##0.00",{reverse:!0}),$("#group #item_weight").mask("# ##0.00",{reverse:!0}),$("#group #item_date").last().datepicker({position:"right bottom",autoClose:!0})),"carrier-group"===e&&$("#carrier_price").mask("# ##0.00",{reverse:!0}),"account-group"===e&&($("#group #account_price").mask("# ##0.00",{reverse:!0}),$("#group #account_date").last().datepicker({position:"right bottom",autoClose:!0}),$("#shipment_date").datepicker({position:"right bottom",autoClose:!0})),"flight-group"===e&&($("#delivery_flight_sum").mask("# ##0.00",{reverse:!0}),$("#delivery_flight_weight").mask("# ##0.00",{reverse:!0})),"delivery-group"===e&&($("#delivery_start_date").datepicker({position:"right top",autoClose:!0}),$("#delivery_end_date").datepicker({position:"right top",autoClose:!0}),$("#group #delivery_date").last().datepicker({position:"right bottom",autoClose:!0}),$("#delivery_price").mask("# ##0.00",{reverse:!0})));$("#group").children().length<=1&&$('[name="remove_last_group"]').fadeOut(0),saveCard()}function getItemsList(e,t,i){$.ajax({url:"/getAllItems",type:"GET",dataType:"html",success:function(n){n=JSON.parse(n);let a='<option value="disabled" selected disabled>Выбрать</option>',l=[];for(let e=0;e<n.length;e++)l.push(n[e].Name);for(let e=0;e<l.length-1;e++)for(let t=e+1;t<l.length;t++)l[e]==l[t]&&(l.splice(t,1),t--);for(let e=0;e<l.length;e++)a+=`<option value="${l[e]}">${l[e]}</option>`;if($(`#${e}`).empty(),$(`#${e}`).append(a),e.includes("item_product")){let i=0;$('.hmax #group [name="items_list"]').each(function(){""==t.Name?$(`#${e} option:contains('Выбрать')`).attr("selected",!0):($(`#${e} option`).each(function(e,i){$(i).html()==t.Name&&$(i).attr("selected",!0)}),$(`#${e} :selected`).val($(`#${e} :selected`).html())),i++})}else itemSelection(i,t)}})}function itemSelection(e,t){if("client"===e||"provider"===e)""==t.Category?$(`#${e}_category option:contains('Выбрать')`).attr("selected",!0):($(`#${e}_category option:contains('${t.Category}')`).attr("selected",!0),$(`#${e}_category :selected`).val($(`#${e}_category :selected`).html())),""==t.Segment?$(`#${e}_industry option:contains('Выбрать')`).attr("selected",!0):($(`#${e}_industry option:contains('${t.Segment}')`).attr("selected",!0),$(`#${e}_industry :selected`).val($(`#${e}_industry :selected`).html()));else{let t=$(`#${e.id} :selected`);t.val(t.html())}saveCard()}function selectManagerInCard(e){let t=e.id,i=$(e).attr("card");closeCardMenu(i),i=i.split("_"),$.ajax({url:"/addManagerToCard",type:"GET",data:{category:i[0],card_id:+i[1],manager_id:t},dataType:"html",success:function(){let e=getCurrentDateNotComparison("year").split(".");e[2]=+e[2]+1,e=e.join(".");let n,a=[{name:"client",text:"клиента"},{name:"provider",text:"поставщика"},{name:"carrier",text:"перевозчика"}];for(let e=0;e<saveTableAndCard[1][1].length;e++)saveTableAndCard[1][1][e].id==i[1]&&(n=saveTableAndCard[1][1][e].Name);for(let l=0;l<a.length;l++)if(a[l].name==i[0]){let i={task_type:"other",task_whom:[t],task_who:1,task_date:e,task_time:"00:00",task_comment:`У Вас новая карточка ${a[l].text} ${n}`};socket.emit("addTask",{data:i});break}}})}function unfastenCard(){$(".drop_menu").fadeIn(200)}function detachmentCard(e){$.ajax({url:"/getThisUser",type:"GET",dataType:"html",success:function(t){t=JSON.parse(t);let i,n=e.id.split("_");for(let e=0;e<categoryInListClient[1][1].length;e++)if(categoryInListClient[1][1][e].id==n[1]){i=categoryInListClient[1][1][e];break}if("manager"==t.role&&i.Manager_id!=t.id)return $(".page").append($("<div>",{class:"background"}).add('\n                            <div class="modal_select">\n                                <div class="title">\n                                    <span>Ошибка</span>\n                                    <img onclick="closeModal()" src="static/images/cancel.png">\n                                </div>\n                                <div class="content">\n                                    <div class="message">\n                                        <p style="font-size: 13px; color: #595959;">Вы не можете это сделать!</p>\n                                    </div>\n                                </div>\n                            </div>\n                        '));closeCardMenu(e.id),$.ajax({url:"/deleteManagerFromCard",type:"GET",data:{category:n[0],card_id:n[1],date:getCurrentDateNotComparison("year")},dataType:"html",success:function(){}}),$("#empty_customer_cards").append($("<div>",{class:"fieldInfo padd",id:`${n[0]}_${n[1]}`,onclick:"createCardMenu(this)",append:$("<div>",{class:"name",html:$(`#${n[0]}_name`).val()}).add($("<div>",{class:"row",append:$("<div>",{class:"descr",html:`Снято с ${username}`}).add($("<div>",{class:"time",html:`Свободна с <span id="free_card_date" class="bold">${getCurrentDateNotComparison()}</span>`}))}))}));for(let e=0;e<dataName.length;e++)dataName[e].name===n[0]&&getTableData(dataName[e].link)}})}function saveCard(){null!=$("#card_menu").html()&&(saveTableAndCard[0].lastCard[0]=$("#card_menu"))}