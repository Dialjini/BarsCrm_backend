let socket=io();$(document).ready(function(){addButtonsSubcategory(0),getTableData(categoryInListClient),createCategoryMenu(),createCTButtons(),linkField(),getUserInfo(),$("#clientButton, #category-0").addClass("active"),socket.emit("connection"),socket.emit("showTasks")}),socket.on("showTasks",function(a){$("#current_tasks").empty(),$("#expired_tasks").empty(),taskCreate(a)}),socket.on("refreshTasks",function(){socket.emit("showTasks")});let user;socket.on("user joined",function(){});function getUserInfo(){$.ajax({url:"/getThisUser",type:"GET",dataType:"html",success:function(a){a=JSON.parse(a);let b=a.role,c=a.second_name;user=a,b="admin"==b?"\u0410\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440":"\u041C\u0435\u043D\u0435\u0434\u0436\u0435\u0440",c==null&&(c=""),$("#username").append(`<div class="name">${c} ${a.name}</div>`),$("#username").append(`<div class="descr">${b}</div>`),socket.emit("add user",c)}})}function getTableData(a,b=!1,c=!1){let d=function(){return{getRequest:function(a,b,c){function d(d){if($("table").is(".table")&&!c||$("div").is(".card_menu")&&!c){$(".table").remove();for(let b=a[0].lastCard.length-1;0<=b;b--)null!=a[0].lastCard[b]&&(a[0].lastCard[b]=null);a[1].pop(),setTimeout(()=>{$(".card_menu, .overflow").remove()},0)}"analytics"!==a[0].id&&a[1][1]===void 0&&a[1].push(d),b||$(".info").append(fillingTables(a)),"analytics"==saveTableAndCard[0].id&&"manager"==user.role&&($("#analytics_reports .field_with_modal")[0].children[0].innerHTML="\u0421\u0432\u043E\u0434\u043D\u044B\u0439 \u043F\u043E \u043E\u0431\u044A\u0451\u043C\u0430\u043C",$(".table").width("fit-content")),("client"==a[0].id||"carrier"==a[0].id||"provider"==a[0].id)&&sortTableByArea("min",!1),$(`.drop-down, #search_dropMenu`).removeClass("active"),$(".drop_down_search").remove(),$.ajax({url:"/getUsers",type:"GET",dataType:"html",success:function(b){$("#empty_customer_cards").empty(),"client"==a[0].id?fillingDisableCardClient(JSON.parse(b)):"provider"==a[0].id&&fillingDisableCardProvider(JSON.parse(b))}}),$("#find_competitor").remove(),"client"==saveTableAndCard[0].id&&$(".fields").append(`<div class="btn btn-main btn-div" id="find_competitor" onclick="searchByCompetitor()">Поиск по конкурентам</div>`)}const e=[{table:categoryInListClient,request:"/getClients"},{table:categoryInListProvider,request:"/getProviders"},{table:categoryInListCarrier,request:"/getCarriers"},{table:categoryInFinanceDebit,request:"/getAccounts"},{table:categoryInFinanceAccount,request:"/getAccounts"},{table:categoryInDelivery,request:"/getDeliveries"},{table:categoryInStock,request:"/getStockTable"},{table:categoryInAnalytics,request:"/getClients"}];for(let f=0;f<e.length;f++)e[f].table===a&&$.ajax({url:e[f].request,type:"GET",dataType:"html",beforeSend:function(){$(".info").append(function(){return $("<div>",{class:"table",id:"loading"})}()),$("#loading").fadeIn(100)},success:function(a){d(JSON.parse(a))},complete:function(){$("#loading").remove()}})}}}();d.getRequest(a,b,c)}function fillingDisableCardClient(a){function b(b){for(let c=0;c<a.length;c++)if(a[c].id==b)return`Снято с ${a[c].second_name}`;return``}function c(a){return null==a||""==a?`За этой карточкой ни разу не был закреплен менеджер`:`Свободна с <span id="free_card_date" class="bold">${a}</span>`}let d=categoryInListClient[1][1];for(let e=0;e<d.length;e++)d[e].Manager_active||$("#empty_customer_cards").prepend($("<div>",{class:"fieldInfo padd",id:`client_${d[e].id}`,onclick:"createCardMenu(this)",append:$("<div>",{class:"name",html:d[e].Name}).add($("<div>",{class:"row",append:$("<div>",{class:"descr",html:b(d[e].Manager_id)}).add($("<div>",{class:"time",html:c(d[e].Manager_date)}))}))}))}function fillingDisableCardProvider(a){function b(b){for(let c=0;c<a.length;c++)if(a[c].id==b)return`Снято с ${a[c].second_name}`;return``}function c(a){return null==a?`За этой карточкой ни разу не был закреплен менеджер`:`Свободна с <span id="free_card_date" class="bold">${a}</span>`}let d=categoryInListProvider[1][1];for(let e=0;e<d.length;e++)d[e].Manager_active||$("#empty_customer_cards").prepend($("<div>",{class:"fieldInfo padd",id:`provider_${d[e].id}`,onclick:"createCardMenu(this)",append:$("<div>",{class:"name",html:d[e].Name}).add($("<div>",{class:"row",append:$("<div>",{class:"descr",html:b(d[e].Manager_id)}).add($("<div>",{class:"time",html:c(d[e].Manager_date)}))}))}))}function saveInfoCard(a,b=!1,c=null,d="none"){function e(){"client"==l[0]&&(k[`livestock_general`]=$("#livestock_general").val(),k[`livestock_milking`]=$("#livestock_milking").val(),k[`livestock_milkyield`]=$("#livestock_milkyield").val(),k[`demand_product`]=$("#demand_product").val(),k[`demand_volume`]=$("#demand_volume").val()),k[`${l[0]}_data`]=m,k[`${l[0]}_site`]=""===$(`#${l[0]}_site`).val()?$(`#${l[0]}_site`).html():$(`#${l[0]}_site`).val(),k[`${l[0]}_holding`]=""===$(`#${l[0]}_holding`).val()?$(`#${l[0]}_holding`).html():$(`#${l[0]}_holding`).val()}function f(){let a=[];"new"==m&&(m=saveTableAndCard[1][1].length+1),$("#group tr").each(function(b,c){if("client"==l[0])a.push({item_product:$(c).children()[0].children[0].value,item_volume:$(c).children()[1].children[0].value,item_creator:$(c).children()[2].children[0].value,item_price:$(c).children()[3].children[0].value});else if("provider"==l[0])a.push({item_product:$(c).children()[0].children[0].value,item_price:$(c).children()[1].children[0].value,item_date:$(c).children()[2].children[0].value,item_vat:$(c).children()[3].children[0].value,item_packing:$(c).children()[4].children[0].value,item_weight:$(c).children()[5].children[0].value,item_fraction:$(c).children()[6].children[0].value});else return;let d=Object.keys(a[a.length-1]),e=0;for(let f=0;f<d.length;f++)""==a[a.length-1][d[f]]&&e++;e==d.length&&a.pop()}),$.ajax({url:"/addItems",type:"GET",data:{category:l[0],id:m,item:JSON.stringify(a)},dataType:"html",success:function(){}})}function g(a){function b(a){$(".close").is(`#${saveTableAndCard[0].id}_close_card_new`)&&$(`#${saveTableAndCard[0].id}_close_card_new`).attr("id",`${saveTableAndCard[0].id}_close_card_${saveTableAndCard[1][1].length+1}`),$(".card_menu").remove(),$(".info").append($("<div>",{class:"card_menu",id:"contract-decor",append:getTitleInfo({id:`${a.id}`,list:["\u041E\u0444\u043E\u0440\u043C\u043B\u0435\u043D\u0438\u0435 \u0434\u043E\u0433\u043E\u0432\u043E\u0440\u0430"],status:`${a.name.split("_")[1]}_contract`}).add($("<div>",{class:"content",append:contractContentCard(a)}))}));for(let b=0;b<dataName.length;b++)if(a.id==dataName[b].name){dataName[b].link[0].lastCard[1]=$(".card_menu");break}}let d=[];"new"==m&&(m=saveTableAndCard[1][1].length+1),$("#member .member").each(function(a,b){let c=!!$(b).children()[1].id.includes("visible");d.push({role:$(b).children()[0].children[0].children[0].value,phone:$(b).children()[0].children[0].children[1].value,last_name:$(b).children()[0].children[1].children[0].value,first_name:$(b).children()[0].children[1].children[1].value,email:$(b).children()[0].children[1].children[2].value,visible:c});let e=Object.keys(d[0]),f=0;for(let c=0;c<e.length-1;c++)""==d[d.length-1][e[c]]&&f++;f==e.length-1&&d.pop()}),$.ajax({url:"/addContacts",type:"GET",data:{category:l[0],id:m,contacts:JSON.stringify(d)},dataType:"html",success:function(){null!==c&&b(c),getTableData(saveTableAndCard,!1,a)}})}let h=function(){return{getRequest:function(a,c){$.ajax({url:c,type:"GET",data:a,dataType:"html",success:function(){f(),g(b)}})}}}(),k={};const l=a.split("_");let m=l[l.length-1];if("contract"===m||checkEmail()){if("account"==l[0]){let a=m,b=[];for(let a of $("#group tr")){let c=$(a)[0].children[0].children[0].value,d=$(a)[0].children[1].children[0].value;b.push({date:c,sum:d})}return 0==b.length&&b.push({date:"",sum:""}),$.ajax({url:"/addAccountPaymentHistory",data:{account_id:+a,account_payment_history:JSON.stringify(b)},type:"GET",async:!1,dataType:"html",success:function(){}}),void getTableData(saveTableAndCard)}if("contract"===m||"stock"==l[0]||"debit"==l[0])return void getTableData(saveTableAndCard);for(let a=0;a<idCardFields.length;a++)if(l[0]==idCardFields[a].name){const b=idCardFields[a].request;for(let b=0;b<idCardFields[a].ids.length;b++)k[idCardFields[a].ids[b]]=$(`#${idCardFields[a].ids[b]}`).val();if("provider"===l[0]){let a=[];for(let b of $("#group tr"))a.push({item_product:$(b).children()[0].children[0].value,item_price:$(b).children()[1].children[0].value,item_date:$(b).children()[2].children[0].value,item_vat:$(b).children()[3].children[0].value,item_packing:$(b).children()[4].children[0].value,item_weight:$(b).children()[5].children[0].value,item_fraction:$(b).children()[6].children[0].value});k.provider_item_list=JSON.stringify(a)}if(e(a),"check"==d&&("client"==l[0]||"carrier"==l[0])){if(isNaN(+k[`${l[0]}_address`].slice(0,6)))return alert("\u0412 \u043D\u0430\u0447\u0430\u043B\u0435 \u0430\u0434\u0440\u0435\u0441\u0430 \u043D\u0443\u0436\u043D\u043E \u0443\u043A\u0430\u0437\u0430\u0442\u044C \u043F\u043E\u0447\u0442\u043E\u0432\u044B\u0439 \u0438\u043D\u0434\u0435\u043A\u0441");if(""==k[`${l[0]}_inn`])return alert("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0418\u041D\u041D")}h.getRequest(k,b);break}}}let getCommentsInfo=function(){function a(a,b){if(0==a.length)addComment();else{$(`#messages, #comments`).empty();let c=[];for(let b=0;b<a.length;b++)c.push({name:a[b].Manager,date:a[b].Date.split(" ")[0]});for(let a=0;a<c.length-1;a++)for(let b=a+1;b<c.length;b++)c[a].name===c[b].name&&(""!=c[b].date&&(c[a].date=c[b].date),c.splice(b,1),b--);for(let a=0;a<c.length;a++)addComment(c[a],b);$("#add_new_comment").attr("onclick","addComment()")}1>=$(`#messages`).children().length&&$(`[name="remove_last_comment"]`).fadeOut(0),"search"==b[2]&&("client"==b[0]?(categoryInListClient[0].lastCard[0]=$(".card_menu"),categoryInListClient[0].active=!0,categoryInListProvider[0].active=!1,categoryInListCarrier[0].active=!1):"provider"==b[0]?(categoryInListProvider[0].lastCard[0]=$(".card_menu"),categoryInListProvider[0].active=!0,categoryInListClient[0].active=!1,categoryInListCarrier[0].active=!1):"carrier"==b[0]?(categoryInListCarrier[0].lastCard[0]=$(".card_menu"),categoryInListCarrier[0].active=!0,categoryInListClient[0].active=!1,categoryInListProvider[0].active=!1):alert("\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A!"),linkCategory("category-0"),linkField())}return{getRequest:function(b){function c(){$.ajax({url:"/getMessages",type:"GET",data:{category:b[0],id:b[1]},dataType:"html",success:function(c){a(JSON.parse(c),b)}})}if("string"==typeof b){let a={comment_date:$("#comment_date").val(),comment_role:$("#comment_role").val(),comment_content:$("#comment_content").val()};if(null==a.comment_role)return void addComment();b=b.split("_");let d=0,e=Object.keys(a);for(let b=0;3>b;b++)(""==a[e[b]]||null==a[e[b]])&&d++;if(3==d)return void c();$.ajax({url:"/addMessages",type:"GET",data:{category:b[0],id:b[1],comments:JSON.stringify(a)},dataType:"html",success:function(){c()}})}else c()}}}();$("#search").keydown(function(a){13===a.keyCode&&searchCategoryInfo()}),$("#search_button").click(function(){searchCategoryInfo()});function cancelSearch(){for(let a=0;a<dataName.length;a++)if(saveTableAndCard[0].id==dataName[a].name){"stock"==saveTableAndCard[0].id&&($(".row").remove(),addButtonsSubcategory(3),linkField()),getTableData(dataName[a].link);break}$(".centerBlock .header .cancel").remove(),$("#search").val(""),$(".modal_search").remove(),$(".overflow").remove(),sortStatus={product:{status:!1,filter:null,last:null},price:{status:!1,filter:null},area:{status:!1,filter:null},category:{status:!1,filter:null,last:null},manager:{status:!1,filter:null,last:null}}}function searchFill(a){$(".centerBlock .header .cancel").remove();let b=$(a).html(),c=saveTableAndCard[1][1],d=[{id:"client",list:"Rayon",filter:filterClient},{id:"provider",list:"Rayon",filter:filterProvider},{id:"carrier",list:"Region",filter:filterCarrier}],e=[];for(let f=0;f<d.length;f++)if(d[f].id==saveTableAndCard[0].id){for(let a,g=0;g<c.length;g++)a=(c[g][d[f].list]+"").toLowerCase(),a.includes(b.toLowerCase())&&e.push(c[g]);let a=[];for(let b=0;b<e.length;b++)"\u041A\u043B\u0438\u0435\u043D\u0442"===e[b].Category&&(a.push(e[b]),e.splice(b,1),b--);for(let b=0;b<a.length;b++)e.push(a[b]);d[f].filter[1][1]=e.reverse(),$(".table").remove(),$(".info").append(fillingTables(d[f].filter,!0));break}$(".centerBlock .header .cancel").remove(),$(".centerBlock .header").append(`<div class="cancel"><button class="btn btn-main" onclick="cancelSearch()">Отменить поиск</button></div>`)}function openCardMenu(a){a.id.split("_");$(".modal_select").remove(),$(".overflow").remove(),createCardMenu(a)}function searchCategoryInfo(){$(".centerBlock .header .cancel").remove();let a=$("#search").val();if(!isNaN(+a)&&3<a.length)return void $.ajax({url:"/findContacts",type:"GET",data:{data:+a},dataType:"html",success:function(a){function b(){let a=$("<table>",{class:"table_search"});a.append(`<tr><th>Телефон</th><th>ФИО</th><th width="300">Организация</th><th>Должность</th><th>Статус</th></tr>`);for(let b=0;b<c.length;b++){let d,e,f;null==c[b].Client_id?null==c[b].Provider_id?null!=c[b].Carrier_id&&(f=$("<tr>",{id:`carrier_${c[b].Carrier_id}_search`,onclick:"openCardMenu(this)"}),e={request:"/getCarriers",id:c[b].Carrier_id,mainTable:categoryInListCarrier}):(f=$("<tr>",{id:`provider_${c[b].Provider_id}_search`,onclick:"openCardMenu(this)"}),e={request:"/getProviders",id:c[b].Provider_id,mainTable:categoryInListProvider}):(f=$("<tr>",{id:`client_${c[b].Client_id}_search`,onclick:"openCardMenu(this)"}),e={request:"/getClients",id:c[b].Client_id,mainTable:categoryInListClient}),$.ajax({url:e.request,type:"GET",dataType:"html",success:function(a){d=JSON.parse(a),null==e.mainTable[1][1]&&e.mainTable[1].push(d);for(let g=0;g<d.length;g++)if(e.id==d[g].id){let a=c[b].Visible?"\u0410\u043A\u0442\u0438\u0432\u0435\u043D":"\u0410\u0440\u0445\u0438\u0432";f.append(`<td>${c[b].Number}</td><td>${c[b].Last_name} ${c[b].Name}</td><td>${d[g].Name}</td><td>${c[b].Position}</td><td>${a}</td>`);break}}}),a.append(f)}return a}$(".modal_search").remove(),$(".overflow").remove();let c=JSON.parse(a);$(".info").prepend($("<div>",{class:"overflow"})),$(".overflow").height($(".container")[0].scrollHeight),$(".info").append(function(){let a=$("<div>",{class:"modal_select modal_search",append:$("<div>",{class:"title",html:`<span>Поиск по номеру телефона</span><div class="close" onclick="closeModalMenu()"><img src="static/images/cancel.png"></div>`}).add($("<div>",{class:"content",append:b()}))});return a}())}});let b=saveTableAndCard[1][1],c=[{id:"client",list:["id","Name","Oblast","Rayon","Category"],filter:filterClient},{id:"provider",list:["Oblast","Rayon","Name","Group","Price"],filter:filterProvider},{id:"carrier",list:["Name","Region","Area","Capacity","View"],filter:filterCarrier},{id:"account",list:["Prefix","Date","Name","Sum","Status","Hello"],filter:filterAccount},{id:"delivery",list:["Date","Name","Stock","Carrier_id","Prefix","Price","Payment_date"],filter:filterDelivery}],d=[];for(let e=0;e<c.length;e++){if(c[e].id==saveTableAndCard[0].id&&"account"==saveTableAndCard[0].id){for(let f=0;f<b.length;f++)for(let g=0;g<c[e].list.length;g++){let h;if(h="Prefix"==c[e].list[g]?(b[f].items[0][c[e].list[g]]+"").toLowerCase():(b[f].account[c[e].list[g]]+"").toLowerCase(),h.includes(a.toLowerCase())){d.push(b[f]);break}}c[e].filter[1][1]=d,$(".table").remove(),$(".info").append(fillingTables(c[e].filter,!0));break}if(c[e].id==saveTableAndCard[0].id&&"delivery"==saveTableAndCard[0].id){for(let f=0;f<b.length;f++)for(let g,h=0;h<c[e].list.length;h++)if(g=(b[f].delivery[c[e].list[h]]+"").toLowerCase(),g.includes(a.toLowerCase())){d.push(b[f]);break}c[e].filter[1][1]=d,$(".table").remove(),$(".info").append(fillingTables(c[e].filter,!0));break}if(c[e].id==saveTableAndCard[0].id){for(let f=0;f<b.length;f++)for(let g,h=0;h<c[e].list.length;h++)if(g=(b[f][c[e].list[h]]+"").toLowerCase(),g.includes(a.toLowerCase())){d.push(b[f]);break}let f=[];for(let a=0;a<d.length;a++)"\u041A\u043B\u0438\u0435\u043D\u0442"===d[a].Category&&(f.push(d[a]),d.splice(a,1),a--);for(let a=0;a<f.length;a++)d.push(f[a]);c[e].filter[1][1]=d,$(".table").remove(),$(".info").append(fillingTables(c[e].filter,!0));break}}$(".centerBlock .header .cancel").remove(),$(".centerBlock .header").append(`<div class="cancel"><button class="btn btn-main" onclick="cancelSearch()">Отменить поиск</button></div>`)}